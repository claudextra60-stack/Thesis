<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Engineering Drawing VR - Dual Joystick Control</title>
  
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: sans-serif; overflow: hidden; }

    #loading {
      position: fixed; inset: 0; background: #2B2B88; z-index: 999;
      display: flex; justify-content: center; align-items: center;
      color: white; font-size: 2rem; font-weight: bold;
    }
    
    #overlay {
      position: fixed; inset: 0; z-index: 100;
      background: rgba(255,255,255,0.9);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }

    .btn {
      padding: 20px 60px; font-size: 1.5rem; background: #CF2027; color: white;
      border: none; border-radius: 10px; cursor: pointer; margin-top: 20px;
    }
    .btn:hover { background: #2B2B88; }

    #instructions {
      position: fixed; bottom: 20px; left: 20px; z-index: 50;
      background: rgba(0,0,0,0.7); color: white; padding: 15px;
      border-radius: 8px; font-size: 14px;
    }
  </style>

  <script>
    // Global state for Left Grip (Clutch mechanism)
    window.isLeftGripHeld = false;

    // Component for Remote Model Rotation (Clutch Mode)
    AFRAME.registerComponent('remote-rotate-model', {
      init: function () {
        this.rightController = document.getElementById('right-controller');
        this.lastRotation = new THREE.Quaternion();
        this.currentRotation = new THREE.Quaternion();
        this.deltaRotation = new THREE.Quaternion();
        this.isRotating = false;
      },

      tick: function () {
        if (!window.isLeftGripHeld || !this.rightController) {
          if (this.isRotating) {
             this.isRotating = false;
             this.el.sceneEl.emit('resume-view-cycle');
          }
          return;
        }

        if (!this.isRotating) {
          this.isRotating = true;
          this.lastRotation.copy(this.rightController.object3D.quaternion);
          this.el.sceneEl.emit('stop-view-cycle');
          return;
        }

        this.currentRotation.copy(this.rightController.object3D.quaternion);
        this.deltaRotation.copy(this.lastRotation).invert();
        this.deltaRotation.premultiply(this.currentRotation);
        this.el.object3D.quaternion.premultiply(this.deltaRotation);
        this.lastRotation.copy(this.currentRotation);
      }
    });

    // Component for scaling
    AFRAME.registerComponent('scalable-model', {
      init: function () {
        this.scaleStep = 0.1;
        this.minScale = 0.2;
        this.maxScale = 3.0;
        this.currentScale = parseFloat(this.el.getAttribute('scale').x);
      },

      scaleUp: function () {
        this.currentScale = Math.min(this.maxScale, this.currentScale + this.scaleStep);
        this.el.setAttribute('scale', `${this.currentScale} ${this.currentScale} ${this.currentScale}`);
      },

      scaleDown: function () {
        this.currentScale = Math.max(this.minScale, this.currentScale - this.scaleStep);
        this.el.setAttribute('scale', `${this.currentScale} ${this.currentScale} ${this.currentScale}`);
      }
    });

    // Custom Look Controls for Left Joystick (Head Rotation)
    AFRAME.registerComponent('joystick-look-controls', {
      schema: {
        rotationSpeed: { default: 2.0 }
      },
      init: function () {
        this.yaw = 0;
        this.pitch = 0;
      },
      tick: function (time, timeDelta) {
        const leftController = document.getElementById('left-controller');
        if (!leftController) return;
        
        // Access the joystick axis state directly
        // Note: Different browsers/devices map axes differently, usually 2 & 3 for secondary thumbstick
        // But for Oculus Touch via A-Frame tracked-controls, it's often available on the component
        const trackedControls = leftController.components['tracked-controls'];
        const oculusControls = leftController.components['oculus-touch-controls'];
        
        let axisX = 0, axisY = 0;

        if (oculusControls && oculusControls.axis) {
            axisX = oculusControls.axis[2] || 0; // X axis
            axisY = oculusControls.axis[3] || 0; // Y axis
        } 
        
        // If axis data isn't easily accessible via components, we fallback to event listeners in the controller component
        // See 'vr-controller' tick update below
      },
      
      rotateCamera: function(x, y, dt) {
        const camera = document.getElementById('camera');
        if (!camera) return;

        const sensitivity = this.data.rotationSpeed * (dt / 1000);
        
        // Apply rotation to the camera wrapper (or look-controls offset if accessible)
        // Since look-controls overrides rotation, we manipulate the parent 'camera-rig-rotation-wrapper' if it existed
        // OR we use A-Frame's look-controls 'yawObject' and 'pitchObject' via internal API, 
        // BUT safer is to rotate the Rig for Y (Yaw) and Camera for X (Pitch)
        
        const rig = document.getElementById('rig');
        
        // Y-Axis Rotation (Turning Body/Head Left/Right) -> Rotate Rig
        rig.object3D.rotation.y -= x * sensitivity;

        // X-Axis Rotation (Looking Up/Down) -> Rotate Camera
        // Note: This fights with HMD tracking. Usually VR apps only do Yaw on stick.
        // If user requested "all axes" for head, we try to apply pitch, but HMD will override.
        // We will apply Yaw to Rig.
      }
    });

    // Enhanced controller component
    AFRAME.registerComponent('vr-controller', {
      schema: {
        hand: { type: 'string', default: 'left' }
      },

      init: function () {
        this.onTriggerDown = this.onTriggerDown.bind(this);
        this.onGripDown = this.onGripDown.bind(this);
        this.onGripUp = this.onGripUp.bind(this);
        this.onButtonDown = this.onButtonDown.bind(this);
        this.onThumbstickDown = this.onThumbstickDown.bind(this);
        this.onAxisMove = this.onAxisMove.bind(this);
        
        this.el.addEventListener('triggerdown', this.onTriggerDown);
        this.el.addEventListener('gripdown', this.onGripDown);
        this.el.addEventListener('gripup', this.onGripUp);
        this.el.addEventListener('abuttondown', this.onButtonDown);
        this.el.addEventListener('bbuttondown', this.onButtonDown);
        this.el.addEventListener('xbuttondown', this.onButtonDown);
        this.el.addEventListener('ybuttondown', this.onButtonDown);
        this.el.addEventListener('thumbstickdown', this.onThumbstickDown);
        this.el.addEventListener('axismove', this.onAxisMove);
      },

      onAxisMove: function(evt) {
        // Implementation for Left Joystick Head Rotation
        if (this.data.hand === 'left') {
            const axis = evt.detail.axis;
            if (axis.length >= 2) {
                // axis[0] is X (Left/Right), axis[1] is Y (Up/Down)
                const x = axis[2] !== undefined ? axis[2] : axis[0];
                const y = axis[3] !== undefined ? axis[3] : axis[1];
                
                // Deadzone
                if (Math.abs(x) > 0.1 || Math.abs(y) > 0.1) {
                    const rig = document.getElementById('rig');
                    // Rotate Rig (Yaw)
                    rig.object3D.rotation.y -= x * 0.03;
                }
            }
        }
      },

      onGripDown: function(evt) {
        // Left Grip = Clutch for Rotation
        if (this.data.hand === 'left') {
          window.isLeftGripHeld = true;
          this.el.emit('hapticpulse', { intensity: 0.5, duration: 100 });
        }
        
        // Right Grip = Recenter Menu
        if (this.data.hand === 'right') {
           this.recenterUI();
        }
      },

      onGripUp: function(evt) {
        if (this.data.hand === 'left') {
          window.isLeftGripHeld = false;
        }
      },

      onThumbstickDown: function(evt) {
        const rig = document.getElementById('rig');
        const model = document.getElementById('engineering-model');
        
        // LEFT STICK CLICK: Reset Head View (Face Model)
        if (this.data.hand === 'left') {
            // Calculate vector to look at model
            // Simply resetting rig rotation usually works if model is at default -Z
            rig.object3D.rotation.set(0, 0, 0); 
            // Additionally, ensure camera isn't offset oddly, but HMD handles that.
            
            // Haptic Feedback
            this.el.emit('hapticpulse', { intensity: 0.5, duration: 150 });
            console.log("Head View Reset");
        }
        
        // RIGHT STICK CLICK: Reset Body Position
        if (this.data.hand === 'right') {
            rig.setAttribute('position', '0 0 0');
            this.el.emit('hapticpulse', { intensity: 0.8, duration: 200 });
            console.log("Body Position Reset");
        }
      },

      onTriggerDown: function (evt) {
        const raycaster = this.el.components.raycaster;
        if (!raycaster) return;

        const intersections = raycaster.intersectedEls;
        for (let i = 0; i < intersections.length; i++) {
          const el = intersections[i];
          if (el.classList.contains('interactive')) {
            el.emit('click');
            this.el.emit('hapticpulse', { intensity: 0.5, duration: 50 });
            break;
          }
        }
      },

      onButtonDown: function (evt) {
        const model = document.getElementById('engineering-model');
        const type = evt.type;
        
        if (type === 'abuttondown' || type === 'xbuttondown') {
          if (model && model.components['scalable-model']) {
            model.components['scalable-model'].scaleUp();
            this.el.emit('hapticpulse', { intensity: 0.3, duration: 30 });
          }
        }
        
        if (type === 'bbuttondown' || type === 'ybuttondown') {
          if (model && model.components['scalable-model']) {
            model.components['scalable-model'].scaleDown();
            this.el.emit('hapticpulse', { intensity: 0.3, duration: 30 });
          }
        }
      },

      recenterUI: function() {
        const camera = document.getElementById('camera');
        const toggleBtn = document.getElementById('toggle-panel-btn');
        const panel = document.getElementById('control-panel');
        const help = document.getElementById('help-card');
        const modules = document.getElementById('modules-card');
        
        const camPos = new THREE.Vector3();
        const camDir = new THREE.Vector3();
        
        camera.object3D.getWorldPosition(camPos);
        camera.object3D.getWorldDirection(camDir);
        camDir.y = 0; 
        camDir.normalize();

        const targetPos = new THREE.Vector3();
        targetPos.copy(camPos).add(camDir.multiplyScalar(0.6));
        targetPos.y = camPos.y; 

        // Update all UI elements
        const elements = [toggleBtn, panel, help, modules];
        elements.forEach(el => {
            if(el) {
                el.object3D.position.copy(targetPos);
                el.object3D.lookAt(camPos);
            }
        });

        // Ensure toggle button is visible if nothing else is
        if (!panel.getAttribute('visible') && !help.getAttribute('visible') && !modules.getAttribute('visible')) {
             toggleBtn.setAttribute('visible', true);
        }

        this.el.emit('hapticpulse', { intensity: 0.8, duration: 150 });
      }
    });

    // Follow camera component (Smoothed for normal usage)
    AFRAME.registerComponent('follow-camera', {
      tick: function () {
        if (!this.el.object3D.visible) return;

        const camera = document.getElementById('camera');
        if (!camera) return;

        const camPos = new THREE.Vector3();
        camera.object3D.getWorldPosition(camPos);
        
        const camRot = new THREE.Euler();
        camRot.setFromQuaternion(camera.object3D.quaternion, 'YXZ');

        const distance = 0.7;
        const targetX = camPos.x - Math.sin(camRot.y) * distance;
        const targetZ = camPos.z - Math.cos(camRot.y) * distance;
        const targetY = camPos.y - 0.2;

        this.el.object3D.position.lerp(new THREE.Vector3(targetX, targetY, targetZ), 0.05);
        this.el.object3D.lookAt(camPos.x, camPos.y, camPos.z);
      }
    });
  </script>
</head>

<body>
  <div id="loading">Loading VR...</div>

  <div id="overlay" style="display: none;">
    <h1>VR Engineering Visualizer</h1>
    <p>VR Controls:</p>
    <ul style="text-align: left; margin-bottom: 20px;">
      <li><strong>Left Joystick:</strong> Rotate Head (Look)</li>
      <li><strong>Left Stick Click:</strong> Reset Head View</li>
      <li><strong>Right Joystick:</strong> Move Body (Walk/Fly)</li>
      <li><strong>Right Stick Click:</strong> Reset Body Position</li>
      <li><strong>Right Grip:</strong> Recenter Menu</li>
      <li><strong>Left Grip + Right Hand Move:</strong> Rotate Model</li>
    </ul>
    <button class="btn" id="start-btn">ENTER EXPERIENCE</button>
  </div>

  <div id="instructions" style="display: none;">
    <strong>Controls:</strong><br>
    L-Stick: Look | R-Stick: Move<br>
    L-Click: Reset View | R-Click: Reset Pos<br>
    R-Grip: Recenter Menu<br>
    L-Grip + R-Hand: Rotate Model
  </div>

  <a-scene id="vr-scene" 
           background="color: #E8F4F8" 
           cursor="rayOrigin: mouse" 
           raycaster="objects: .interactive">

    <a-assets>
      <img id="wall-tex" src="https://cdn.architextures.org/textures/23/7/plain-green-sheer-none-twinbru-textiles-12eva5.jpg" crossorigin="anonymous">
      <img id="floor-tex" src="https://cdn.architextures.org/textures/24/5/sand-j9sy8a.jpg" crossorigin="anonymous">
      <img id="ceiling-tex" src="https://cdn.architextures.org/textures/23/8/oatmeal-loop-pile-carpet-cubic-chjny5.jpg" crossorigin="anonymous">
    </a-assets>

    <a-plane position="0 0 0" rotation="-90 0 0" width="20" height="20" src="#floor-tex" repeat="10 10" color="#FFF"></a-plane>
    <a-plane position="0 6 0" rotation="90 0 0" width="20" height="20" src="#ceiling-tex" repeat="10 10" color="#FFF"></a-plane>
    <a-plane position="0 3 -10" width="20" height="6" src="#wall-tex" repeat="10 3" color="#FFF"></a-plane>
    <a-plane position="-10 3 0" rotation="0 90 0" width="20" height="6" src="#wall-tex" repeat="10 3" color="#FFF"></a-plane>
    <a-plane position="10 3 0" rotation="0 -90 0" width="20" height="6" src="#wall-tex" repeat="10 3" color="#FFF"></a-plane>
    <a-plane position="0 3 10" rotation="0 180 0" width="20" height="6" src="#wall-tex" repeat="10 3" color="#FFF"></a-plane>
    
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; position: 1 5 2; intensity: 0.8"></a-entity>

    <a-plane id="exit-btn" class="interactive" position="0 2 9.8" rotation="0 180 0" width="2" height="0.8" color="#CF2027">
      <a-text value="EXIT VR" align="center" width="6" color="#FFF"></a-text>
    </a-plane>

    <a-circle id="toggle-panel-btn" class="interactive" visible="true" follow-camera radius="0.08" color="#2B2B88" 
              animation="property: scale; from: 1 1 1; to: 1.1 1.1 1.1; dir: alternate; loop: true; dur: 1000">
      <a-text value="MENU" align="center" width="1.2" position="0 0 0.01"></a-text>
    </a-circle>

    <a-entity id="control-panel" visible="false" follow-camera>
      <a-plane width="1.2" height="0.8" color="#222" opacity="0.9" class="interactive">
        <a-text value="CONTROLS" position="0 0.32 0.01" align="center" width="2.5" color="#FFF"></a-text>
        
        <a-plane id="btn-close" class="interactive" position="-0.5 0.32 0.02" width="0.12" height="0.12" color="red">
          <a-text value="X" align="center" width="2" position="0 0 0.01"></a-text>
        </a-plane>

        <a-plane id="btn-help" class="interactive" position="0 0.12 0.02" width="0.5" height="0.12" color="#5CCAE8">
          <a-text value="HELP" align="center" width="3" position="0 0 0.01"></a-text>
        </a-plane>

        <a-plane id="btn-modules" class="interactive" position="0 -0.06 0.02" width="0.5" height="0.12" color="#B78A2D">
          <a-text value="MODULES" align="center" width="3" position="0 0 0.01"></a-text>
        </a-plane>

        <a-plane id="btn-exit-panel" class="interactive" position="0 -0.24 0.02" width="0.5" height="0.12" color="#CF2027">
          <a-text value="EXIT" align="center" width="3" position="0 0 0.01"></a-text>
        </a-plane>
      </a-plane>
    </a-entity>

    <a-entity id="help-card" visible="false" follow-camera>
      <a-plane width="0.8" height="1.2" color="#333" opacity="0.95" position="0 0 0.15" class="interactive">
        <a-text value="HELP" position="0 0.52 0.01" align="center" width="2" color="#FFF"></a-text>
        
        <a-plane id="btn-close-help" class="interactive" position="-0.35 0.52 0.02" width="0.1" height="0.1" color="red">
          <a-text value="X" align="center" width="2" position="0 0 0.01"></a-text>
        </a-plane>

        <a-text value="Link 1: Getting Started\nLink 2: User Guide\nLink 3: Tutorials\nLink 4: FAQ\nLink 5: Support" 
                position="0 0 0.01" align="center" width="1.5" color="#AAA" wrap-count="25"></a-text>
      </a-plane>
    </a-entity>

    <a-entity id="modules-card" visible="false" follow-camera>
      <a-plane width="0.8" height="1.2" color="#333" opacity="0.95" position="0 0 0.15" class="interactive">
        <a-text value="MODULES" position="0 0.52 0.01" align="center" width="2" color="#FFF"></a-text>
        
        <a-plane id="btn-close-modules" class="interactive" position="-0.35 0.52 0.02" width="0.1" height="0.1" color="red">
          <a-text value="X" align="center" width="2" position="0 0 0.01"></a-text>
        </a-plane>

        <a-text value="Module 1: Introduction\nModule 2: Basic Concepts\nModule 3: Advanced Topics\nModule 4: Projects\nModule 5: Resources" 
                position="0 0 0.01" align="center" width="1.5" color="#AAA" wrap-count="25"></a-text>
      </a-plane>
    </a-entity>

    <a-entity id="model-container" position="0 1.6 -2.5">
      <a-entity id="engineering-model" 
                scale="0.5 0.5 0.5" 
                rotation="0 0 0"
                remote-rotate-model
                scalable-model>
        <a-box position="0 0 0" width="1.2" height="0.8" depth="0.8" color="#F5F5F5" metalness="0.2" roughness="0.4"></a-box>
        <a-box position="0 0 0" width="1.21" height="0.81" depth="0.81" 
          material="color: #000000; wireframe: true; wireframeLinewidth: 3"></a-box>
        
        <a-cylinder position="0 0 0.42" radius="0.25" height="0.08" color="#F5F5F5" metalness="0.5" roughness="0.3"></a-cylinder>
        <a-cylinder position="0 0 0.42" radius="0.255" height="0.085"
          material="color: #000000; wireframe: true; wireframeLinewidth: 3"></a-cylinder>
        
        <a-box position="0.7 0 0" width="0.4" height="0.6" depth="0.6" color="#F5F5F5" metalness="0.2" roughness="0.4"></a-box>
        <a-box position="0.7 0 0" width="0.41" height="0.61" depth="0.61"
          material="color: #000000; wireframe: true; wireframeLinewidth: 3"></a-box>
        
        <a-cylinder position="0 0.5 0" radius="0.3" height="0.3" color="#F5F5F5" metalness="0.5" roughness="0.3"></a-cylinder>
        <a-cylinder position="0 0.5 0" radius="0.305" height="0.305"
          material="color: #000000; wireframe: true; wireframeLinewidth: 3"></a-cylinder>
        
        <a-box position="-0.5 -0.3 0.3" width="0.2" height="0.2" depth="0.2" color="#F5F5F5" metalness="0.2" roughness="0.4"></a-box>
        <a-box position="-0.5 -0.3 0.3" width="0.21" height="0.21" depth="0.21"
          material="color: #000000; wireframe: true; wireframeLinewidth: 3"></a-box>
      </a-entity>

      <a-text id="view-label" value="Front View" position="0 1.2 0" align="center" color="#2B2B88" width="5"></a-text>
    </a-entity>

    <a-entity id="rig" 
              movement-controls="speed: 0.15; controls: gamepad; fly: true">
              
      <a-entity id="camera" camera position="0 1.6 0" look-controls="pointerLockEnabled: false"></a-entity>

      <a-entity id="left-controller" 
                oculus-touch-controls="hand: left"
                vr-controller="hand: left"
                raycaster="objects: .interactive; far: 10; showLine: true; lineColor: cyan; lineOpacity: 0.75">
      </a-entity>

      <a-entity id="right-controller" 
                oculus-touch-controls="hand: right"
                vr-controller="hand: right"
                raycaster="objects: .interactive; far: 10; showLine: true; lineColor: red; lineOpacity: 0.75">
      </a-entity>
    </a-entity>

  </a-scene>

  <script>
    const scene = document.querySelector('a-scene');
    const model = document.getElementById('engineering-model');
    
    scene.addEventListener('loaded', () => {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('overlay').style.display = 'flex';
    });

    document.getElementById('start-btn').addEventListener('click', () => {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('instructions').style.display = 'block';
      startViewCycle();
    });

    // View cycling system
    let views = [
      {name: 'Front View', rotation: {x: 0, y: 0, z: 0}},
      {name: 'Top View', rotation: {x: 90, y: 0, z: 0}},
      {name: 'Side View', rotation: {x: 0, y: 90, z: 0}},
      {name: 'Isometric View', rotation: {x: 35.26, y: 45, z: 0}}
    ];
    let viewIdx = 0;
    let viewCycleInterval = null;
    let isInteracting = false;
    let lastInteractionTime = 0;

    function startViewCycle() {
      if (viewCycleInterval) clearInterval(viewCycleInterval);
      viewCycleInterval = setInterval(() => {
        const now = Date.now();
        if (window.isLeftGripHeld) {
            lastInteractionTime = now;
            return; 
        }

        if (!isInteracting && (now - lastInteractionTime > 10000 || lastInteractionTime === 0)) {
          viewIdx = (viewIdx + 1) % views.length;
          const view = views[viewIdx];
          const label = document.getElementById('view-label');
          
          label.setAttribute('value', view.name);
          model.setAttribute('animation', {
            property: 'rotation',
            to: `${view.rotation.x} ${view.rotation.y} ${view.rotation.z}`,
            dur: 1200,
            easing: 'easeInOutQuad'
          });
        }
      }, 3000);
    }

    function stopViewCycle() {
      isInteracting = true;
      lastInteractionTime = Date.now();
      document.getElementById('view-label').setAttribute('value', 'Interactive Mode');
      document.getElementById('view-label').setAttribute('color', '#CF2027');
    }

    function resumeViewCycle() {
      isInteracting = false;
      lastInteractionTime = Date.now();
      document.getElementById('view-label').setAttribute('color', '#2B2B88');
    }

    scene.addEventListener('stop-view-cycle', stopViewCycle);
    scene.addEventListener('resume-view-cycle', resumeViewCycle);

    // UI Panel Controls
    document.getElementById('toggle-panel-btn').addEventListener('click', () => {
      const p = document.getElementById('control-panel');
      const btn = document.getElementById('toggle-panel-btn');
      const isVisible = p.getAttribute('visible');
      
      p.setAttribute('visible', !isVisible);
      btn.setAttribute('visible', isVisible);
    });

    document.getElementById('btn-close').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('control-panel').setAttribute('visible', false);
      document.getElementById('toggle-panel-btn').setAttribute('visible', true);
    });

    document.getElementById('btn-help').addEventListener('click', (e) => {
      e.stopPropagation();
      const panel = document.getElementById('control-panel');
      if (panel.getAttribute('visible')) {
        const helpCard = document.getElementById('help-card');
        helpCard.setAttribute('visible', true);
        panel.setAttribute('visible', false);
        document.getElementById('toggle-panel-btn').setAttribute('visible', false);
        document.getElementById('modules-card').setAttribute('visible', false);
      }
    });

    document.getElementById('btn-modules').addEventListener('click', (e) => {
      e.stopPropagation();
      const panel = document.getElementById('control-panel');
      if (panel.getAttribute('visible')) {
        const modulesCard = document.getElementById('modules-card');
        modulesCard.setAttribute('visible', true);
        panel.setAttribute('visible', false);
        document.getElementById('toggle-panel-btn').setAttribute('visible', false);
        document.getElementById('help-card').setAttribute('visible', false);
      }
    });

    document.getElementById('btn-close-help').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('help-card').setAttribute('visible', false);
      document.getElementById('toggle-panel-btn').setAttribute('visible', true);
    });

    document.getElementById('btn-close-modules').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('modules-card').setAttribute('visible', false);
      document.getElementById('toggle-panel-btn').setAttribute('visible', true);
    });

    document.getElementById('btn-exit-panel').addEventListener('click', (e) => {
      e.stopPropagation();
      scene.exitVR();
      document.getElementById('overlay').style.display = 'flex';
      document.getElementById('instructions').style.display = 'none';
      document.getElementById('control-panel').setAttribute('visible', false);
      document.getElementById('toggle-panel-btn').setAttribute('visible', true);
      document.getElementById('help-card').setAttribute('visible', false);
      document.getElementById('modules-card').setAttribute('visible', false);
      if (viewCycleInterval) clearInterval(viewCycleInterval);
    });

    document.getElementById('exit-btn').addEventListener('click', () => {
      scene.exitVR();
      document.getElementById('overlay').style.display = 'flex';
      document.getElementById('instructions').style.display = 'none';
      if (viewCycleInterval) clearInterval(viewCycleInterval);
    });

    // Desktop mouse controls
    let isDragging = false;
    let previousMouseX = 0;
    let previousMouseY = 0;
    let mouseDownOnModel = false;

    model.addEventListener('mousedown', (e) => {
      mouseDownOnModel = true;
      isDragging = true;
      previousMouseX = e.clientX;
      previousMouseY = e.clientY;
      stopViewCycle();
      e.preventDefault();
      e.stopPropagation();
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        mouseDownOnModel = false;
        resumeViewCycle();
      }
    });
    
    document.addEventListener('mousemove', (e) => {
      if (!isDragging || !mouseDownOnModel) return;
      
      e.preventDefault();
      e.stopPropagation();
      
      const deltaX = e.clientX - previousMouseX;
      const deltaY = e.clientY - previousMouseY;
      
      previousMouseX = e.clientX;
      previousMouseY = e.clientY;
      
      model.object3D.rotation.y += deltaX * 0.01;
      model.object3D.rotation.x += deltaY * 0.01;
    });

    const camera = document.getElementById('camera');
    model.addEventListener('mouseenter', () => {
      if (camera.components['look-controls']) {
        camera.components['look-controls'].pause();
      }
    });
    
    model.addEventListener('mouseleave', () => {
      if (!isDragging && camera.components['look-controls']) {
        camera.components['look-controls'].play();
      }
    });

    // Desktop scroll wheel for zoom
    window.addEventListener('wheel', (e) => {
      e.preventDefault();
      const scalable = model.components['scalable-model'];
      if (scalable) {
        if (e.deltaY < 0) {
          scalable.scaleUp();
        } else {
          scalable.scaleDown();
        }
      }
    }, { passive: false });
  </script>
</body>
</html>