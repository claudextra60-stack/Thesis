<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Engineering Drawing VR - Scenery Mode</title>
  <link rel="icon" type="image/png" href="https://i.ibb.co/v4FSdxGv/cropped-circle-image.png">
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2B2B88">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Eng Draw VR">
  
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: sans-serif; overflow: hidden; }

    #loading {
      position: fixed; inset: 0; background: #2B2B88; z-index: 999;
      display: flex; justify-content: center; align-items: center;
      color: white; font-size: 2rem; font-weight: bold;
    }
    
    #overlay {
      position: fixed; inset: 0; z-index: 100;
      background: rgba(255,255,255,0.9);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }

    .btn {
      padding: 20px 60px; font-size: 1.5rem; background: #CF2027; color: white;
      border: none; border-radius: 10px; cursor: pointer; margin-top: 20px;
    }
    .btn:hover { background: #2B2B88; }

    #instructions {
      position: fixed; bottom: 20px; left: 20px; z-index: 50;
      background: rgba(0,0,0,0.7); color: white; padding: 15px;
      border-radius: 8px; font-size: 14px;
    }
  </style>

  <script>
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('Service Worker registered!', reg))
          .catch(err => console.log('Service Worker registration failed', err));
      });
    }

    // --- BIRD FLIGHT COMPONENT ---
    AFRAME.registerComponent('bird-flight', {
      schema: {
        speed: { type: 'number', default: 4 }, // Meters per second
        radius: { type: 'number', default: 25 }, // How far they can fly before turning
        heightRange: { type: 'vec2', default: {x: 10, y: 20} } // Min and Max height
      },
      init: function() {
        // 1. Randomize starting position within the radius
        const angle = Math.random() * Math.PI * 2;
        const dist = Math.random() * this.data.radius;
        const x = Math.cos(angle) * dist;
        const z = Math.sin(angle) * dist;
        const y = this.data.heightRange.x + Math.random() * (this.data.heightRange.y - this.data.heightRange.x);
        
        this.el.object3D.position.set(x, y, z);

        // 2. Random starting rotation (yaw)
        this.el.object3D.rotation.y = Math.random() * Math.PI * 2;

        // 3. State for turning
        this.turnSpeed = 0;
        this.targetTurnSpeed = (Math.random() - 0.5) * 0.02; // Slight natural curve
      },
      tick: function(time, timeDelta) {
        if (!timeDelta) return;
        const deltaSeconds = timeDelta / 1000;
        
        // Move Forward relative to where the bird is facing
        this.el.object3D.translateZ(this.data.speed * deltaSeconds);

        const pos = this.el.object3D.position;

        // Calculate distance from center (0,0,0)
        const distance = Math.sqrt(pos.x * pos.x + pos.z * pos.z);

        // If bird flies too far, steer it back towards center
        if (distance > this.data.radius) {
          // Calculate vector to center
          const angleToCenter = Math.atan2(-pos.x, -pos.z); // Simple target angle
          
          // Smoothly adjust rotation.y towards angleToCenter
          // We cheat a bit by just adding a constant turn when out of bounds
          // To determine Left vs Right turn:
          const currentRot = this.el.object3D.rotation.y;
          // Just force a turn
          this.turnSpeed = 0.015; // Harder turn when out of bounds
        } else {
          // Inside bounds: revert to gentle meandering
          // Randomly change turn speed occasionally
          if (Math.random() < 0.01) {
            this.targetTurnSpeed = (Math.random() - 0.5) * 0.02;
          }
          // LERP turn speed
          this.turnSpeed += (this.targetTurnSpeed - this.turnSpeed) * 0.1;
        }

        // Apply Rotation
        this.el.object3D.rotation.y += this.turnSpeed;

        // Bank (Roll) the bird based on turn speed for realism
        // Negative roll for positive turn (banking into the turn)
        this.el.object3D.rotation.z = -this.turnSpeed * 30; 
        
        // Add slight bobbing (sine wave on Y)
        this.el.object3D.position.y += Math.sin(time / 500) * 0.005;
      }
    });

    // Global state for Left Grip (Clutch mechanism)
    window.isLeftGripHeld = false;

    // Component for Remote Model Rotation (Clutch Mode)
    AFRAME.registerComponent('remote-rotate-model', {
      init: function () {
        this.rightController = document.getElementById('right-controller');
        this.lastRotation = new THREE.Quaternion();
        this.currentRotation = new THREE.Quaternion();
        this.deltaRotation = new THREE.Quaternion();
        this.isRotating = false;
      },

      tick: function () {
        if (!window.isLeftGripHeld || !this.rightController) {
          if (this.isRotating) {
             this.isRotating = false;
             this.el.sceneEl.emit('resume-view-cycle');
          }
          return;
        }

        if (!this.isRotating) {
          this.isRotating = true;
          this.lastRotation.copy(this.rightController.object3D.quaternion);
          this.el.sceneEl.emit('stop-view-cycle');
          return;
        }

        this.currentRotation.copy(this.rightController.object3D.quaternion);
        this.deltaRotation.copy(this.lastRotation).invert();
        this.deltaRotation.premultiply(this.currentRotation);
        this.el.object3D.quaternion.premultiply(this.deltaRotation);
        this.lastRotation.copy(this.currentRotation);
      }
    });

    // Component for scaling
    AFRAME.registerComponent('scalable-model', {
      init: function () {
        this.scaleStep = 0.1;
        this.minScale = 0.2;
        this.maxScale = 3.0;
        this.currentScale = parseFloat(this.el.getAttribute('scale').x);
      },

      scaleUp: function () {
        this.currentScale = Math.min(this.maxScale, this.currentScale + this.scaleStep);
        this.el.setAttribute('scale', `${this.currentScale} ${this.currentScale} ${this.currentScale}`);
      },

      scaleDown: function () {
        this.currentScale = Math.max(this.minScale, this.currentScale - this.scaleStep);
        this.el.setAttribute('scale', `${this.currentScale} ${this.currentScale} ${this.currentScale}`);
      }
    });

    // Enhanced controller component
    AFRAME.registerComponent('vr-controller', {
      schema: {
        hand: { type: 'string', default: 'left' }
      },

      init: function () {
        this.sceneryMode = false; // Track if we are in "Scenery/Hidden" mode
        
        this.onTriggerDown = this.onTriggerDown.bind(this);
        this.onGripDown = this.onGripDown.bind(this);
        this.onGripUp = this.onGripUp.bind(this);
        this.onButtonDown = this.onButtonDown.bind(this);
        this.onThumbstickDown = this.onThumbstickDown.bind(this);
        this.onAxisMove = this.onAxisMove.bind(this);
        
        this.el.addEventListener('triggerdown', this.onTriggerDown);
        this.el.addEventListener('gripdown', this.onGripDown);
        this.el.addEventListener('gripup', this.onGripUp);
        this.el.addEventListener('abuttondown', this.onButtonDown);
        this.el.addEventListener('bbuttondown', this.onButtonDown);
        this.el.addEventListener('xbuttondown', this.onButtonDown);
        this.el.addEventListener('ybuttondown', this.onButtonDown);
        this.el.addEventListener('thumbstickdown', this.onThumbstickDown);
        this.el.addEventListener('axismove', this.onAxisMove);
      },

      onAxisMove: function(evt) {
        // Implementation for Left Joystick Head Rotation
        if (this.data.hand === 'left') {
            const axis = evt.detail.axis;
            if (axis.length >= 2) {
                // axis[0] is X (Left/Right), axis[1] is Y (Up/Down)
                const x = axis[2] !== undefined ? axis[2] : axis[0];
                const y = axis[3] !== undefined ? axis[3] : axis[1];
                
                // Deadzone
                if (Math.abs(x) > 0.1 || Math.abs(y) > 0.1) {
                    const rig = document.getElementById('rig');
                    // Rotate Rig (Yaw)
                    rig.object3D.rotation.y -= x * 0.03;
                }
            }
        }
      },

      onGripDown: function(evt) {
        // Left Grip = Clutch for Rotation
        if (this.data.hand === 'left') {
          window.isLeftGripHeld = true;
          this.el.emit('hapticpulse', { intensity: 0.5, duration: 100 });
        }
        
        // Right Grip = Recenter Menu
        if (this.data.hand === 'right') {
           this.recenterUI();
        }
      },

      onGripUp: function(evt) {
        if (this.data.hand === 'left') {
          window.isLeftGripHeld = false;
        }
      },

      onThumbstickDown: function(evt) {
        const rig = document.getElementById('rig');
        const model = document.getElementById('engineering-model');
        const modelContainer = document.getElementById('model-container');
        const camera = document.getElementById('camera');

        // LEFT STICK CLICK: Reset Head View & Align Model to Eye Level
        if (this.data.hand === 'left') {
            rig.object3D.rotation.set(0, 0, 0); 
            
            const camPos = new THREE.Vector3();
            camera.object3D.getWorldPosition(camPos);

            modelContainer.object3D.position.set(0, camPos.y, -2.5);
            model.object3D.rotation.set(0, 0, 0);

            this.el.emit('hapticpulse', { intensity: 0.5, duration: 150 });
            
            const label = document.getElementById('view-label');
            if(label) label.setAttribute('value', 'Front View (Eye Level)');
        }
        
        // RIGHT STICK CLICK: Reset Body Position
        if (this.data.hand === 'right') {
            rig.setAttribute('position', '0 0 0');
            this.el.emit('hapticpulse', { intensity: 0.8, duration: 200 });
        }
      },

      onTriggerDown: function (evt) {
        // Disable interactions if in Scenery Mode
        if (this.sceneryMode) return; 

        const raycaster = this.el.components.raycaster;
        if (!raycaster) return;

        const intersections = raycaster.intersectedEls;
        for (let i = 0; i < intersections.length; i++) {
          const el = intersections[i];
          if (el.classList.contains('interactive')) {
            el.emit('click');
            this.el.emit('hapticpulse', { intensity: 0.5, duration: 50 });
            break;
          }
        }
      },

      onButtonDown: function (evt) {
        const model = document.getElementById('engineering-model');
        const type = evt.type;
        
        // --- X BUTTON: TOGGLE SCENERY MODE ---
        if (type === 'xbuttondown') {
          this.toggleScenery();
          return;
        }

        // --- A BUTTON: SCALE UP ---
        if (type === 'abuttondown') {
          if (!this.sceneryMode && model && model.components['scalable-model']) {
            model.components['scalable-model'].scaleUp();
            this.el.emit('hapticpulse', { intensity: 0.3, duration: 30 });
          }
        }
        
        // --- B or Y BUTTON: SCALE DOWN ---
        if (type === 'bbuttondown' || type === 'ybuttondown') {
          if (!this.sceneryMode && model && model.components['scalable-model']) {
            model.components['scalable-model'].scaleDown();
            this.el.emit('hapticpulse', { intensity: 0.3, duration: 30 });
          }
        }
      },

      toggleScenery: function() {
        this.sceneryMode = !this.sceneryMode;
        
        // Elements to hide
        const idsToHide = [
            'model-container',
            'exit-btn', 
            'toggle-panel-btn', 
            'control-panel', 
            'help-card', 
            'modules-card'
        ];

        if (this.sceneryMode) {
            // Hide everything
            idsToHide.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.setAttribute('visible', false);
            });
            this.el.emit('hapticpulse', { intensity: 0.8, duration: 300 }); // Long pulse for OFF
        } else {
            // RESTORE DEFAULT VIEW
            // We only bring back the Model, Exit sign, and Menu Button. 
            // We keep the panels closed to ensure a clean return.
            document.getElementById('model-container').setAttribute('visible', true);
            document.getElementById('exit-btn').setAttribute('visible', true);
            document.getElementById('toggle-panel-btn').setAttribute('visible', true);
            
            this.el.emit('hapticpulse', { intensity: 0.3, duration: 100 }); // Short pulse for ON
        }
      },

      recenterUI: function() {
        // Don't recenter if everything is hidden
        if (this.sceneryMode) return;

        const camera = document.getElementById('camera');
        const toggleBtn = document.getElementById('toggle-panel-btn');
        const panel = document.getElementById('control-panel');
        const help = document.getElementById('help-card');
        const modules = document.getElementById('modules-card');
        
        const camPos = new THREE.Vector3();
        const camDir = new THREE.Vector3();
        
        camera.object3D.getWorldPosition(camPos);
        camera.object3D.getWorldDirection(camDir);
        camDir.y = 0; 
        camDir.normalize();

        const targetPos = new THREE.Vector3();
        targetPos.copy(camPos).add(camDir.multiplyScalar(0.6));
        targetPos.y = camPos.y; 

        // Update all UI elements
        const elements = [toggleBtn, panel, help, modules];
        elements.forEach(el => {
            if(el) {
                el.object3D.position.copy(targetPos);
                el.object3D.lookAt(camPos);
            }
        });

        if (!panel.getAttribute('visible') && !help.getAttribute('visible') && !modules.getAttribute('visible')) {
             toggleBtn.setAttribute('visible', true);
        }

        this.el.emit('hapticpulse', { intensity: 0.8, duration: 150 });
      }
    });

    // Follow camera component
    AFRAME.registerComponent('follow-camera', {
      tick: function () {
        if (!this.el.object3D.visible) return;

        const camera = document.getElementById('camera');
        if (!camera) return;

        const camPos = new THREE.Vector3();
        camera.object3D.getWorldPosition(camPos);
        
        const camRot = new THREE.Euler();
        camRot.setFromQuaternion(camera.object3D.quaternion, 'YXZ');

        const distance = 0.7;
        const targetX = camPos.x - Math.sin(camRot.y) * distance;
        const targetZ = camPos.z - Math.cos(camRot.y) * distance;
        const targetY = camPos.y - 0.2;

        this.el.object3D.position.lerp(new THREE.Vector3(targetX, targetY, targetZ), 0.05);
        this.el.object3D.lookAt(camPos.x, camPos.y, camPos.z);
      }
    });
  </script>
</head>

<body>
  <div id="loading">Loading VR...</div>

  <div id="overlay" style="display: none;">
    <h1>VR Engineering Visualizer</h1>
    <p>VR Controls:</p>
    <ul style="text-align: left; margin-bottom: 20px;">
      <li><strong>Left Joystick:</strong> Rotate Head (Look)</li>
      <li><strong>Right Joystick:</strong> Move Body (Walk/Fly)</li>
      <li><strong>X Button:</strong> Toggle Scenery (Hide UI)</li>
      <li><strong>A / B Buttons:</strong> Scale Model</li>
      <li><strong>Left Stick Click:</strong> Reset View</li>
      <li><strong>Left Grip + Move:</strong> Rotate Model</li>
    </ul>
    <button class="btn" id="start-btn">ENTER EXPERIENCE</button>
  </div>

  <div id="instructions" style="display: none;">
    <strong>Controls:</strong><br>
    L-Stick: Look | R-Stick: Move<br>
    X Btn: Toggle Scenery Mode (Hide All)<br>
    A/B: Scale | L-Grip: Rotate Model
  </div>

  <a-scene id="vr-scene"
           cursor="rayOrigin: mouse" 
           raycaster="objects: .interactive">

    <a-assets>
      <img id="sky-panorama" src="https://dl.polyhaven.org/file/ph-assets/HDRIs/extra/Tonemapped%20JPG/secluded_beach.jpg" crossorigin="anonymous">
      <img id="sand-tex" src="https://cdn.architextures.org/textures/24/5/sand-j9sy8a.jpg" crossorigin="anonymous">

      <a-asset-item id="parrot-model" src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r129/examples/models/gltf/Parrot.glb"></a-asset-item>
      <a-asset-item id="flamingo-model" src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r129/examples/models/gltf/Flamingo.glb"></a-asset-item>
      <a-asset-item id="stork-model" src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r129/examples/models/gltf/Stork.glb"></a-asset-item>
    </a-assets>

    <a-sky src="#sky-panorama" rotation="0 -90 0" material="side: back"></a-sky>

    <a-entity id="birds">
        <a-entity gltf-model="#parrot-model" 
                  scale="0.02 0.02 0.02" 
                  animation-mixer="clip: *; timeScale: 1.2"
                  bird-flight="speed: 5.5; radius: 30; heightRange: 8 15"></a-entity>
        <a-entity gltf-model="#parrot-model" 
                  scale="0.02 0.02 0.02" 
                  animation-mixer="clip: *; timeScale: 1.1"
                  bird-flight="speed: 6.0; radius: 35; heightRange: 10 20"></a-entity>

        <a-entity gltf-model="#flamingo-model" 
                  scale="0.03 0.03 0.03" 
                  animation-mixer="clip: *; timeScale: 0.8"
                  bird-flight="speed: 3.5; radius: 40; heightRange: 15 25"></a-entity>
        <a-entity gltf-model="#flamingo-model" 
                  scale="0.03 0.03 0.03" 
                  animation-mixer="clip: *; timeScale: 0.9"
                  bird-flight="speed: 3.8; radius: 45; heightRange: 12 22"></a-entity>

        <a-entity gltf-model="#stork-model" 
                  scale="0.03 0.03 0.03" 
                  animation-mixer="clip: *; timeScale: 0.7"
                  bird-flight="speed: 4.5; radius: 50; heightRange: 20 40"></a-entity>
        <a-entity gltf-model="#stork-model" 
                  scale="0.03 0.03 0.03" 
                  animation-mixer="clip: *; timeScale: 0.75"
                  bird-flight="speed: 4.8; radius: 50; heightRange: 25 45"></a-entity>
    </a-entity>

    <a-plane position="0 0 0" rotation="-90 0 0" width="20" height="20" src="#sand-tex" repeat="10 10" color="#FFF"></a-plane>

    <a-ring position="0 0.01 0" rotation="-90 0 0" radius-inner="10" radius-outer="40" src="#sand-tex" repeat="15 15" color="#FFF"></a-ring>

    <a-entity light="type: ambient; intensity: 1; color: #FFF8DC"></a-entity>
    <a-entity light="type: directional; position: 5 10 7.5; intensity: 1.5; color: #FFFACD" 
              animation="property: light.intensity; from: 1.5; to: 1.8; dir: alternate; loop: true; dur: 3000"></a-entity>
    <a-entity light="type: hemisphere; groundColor: #A1887F; intensity: 0.6"></a-entity>

    <a-plane id="exit-btn" class="interactive" position="0 2 9.8" rotation="0 180 0" width="2" height="0.8" color="#CF2027">
      <a-text value="EXIT VR" align="center" width="6" color="#FFF" position="0 0 0.01"></a-text>
    </a-plane>

    <a-circle id="toggle-panel-btn" class="interactive" visible="true" follow-camera radius="0.08" color="#2B2B88" 
              animation="property: scale; from: 1 1 1; to: 1.1 1.1 1.1; dir: alternate; loop: true; dur: 1000">
      <a-text value="MENU" align="center" width="1.2" position="0 0 0.02"></a-text>
    </a-circle>

    <a-entity id="control-panel" visible="false" follow-camera>
      <a-plane width="1.2" height="0.8" color="#222" opacity="0.9" class="interactive">
        <a-text value="CONTROLS" position="0 0.32 0.02" align="center" width="2.5" color="#FFF"></a-text>
        
        <a-plane id="btn-close" class="interactive" position="-0.5 0.32 0.03" width="0.12" height="0.12" color="red">
          <a-text value="X" align="center" width="2" position="0 0 0.01"></a-text>
        </a-plane>

        <a-plane id="btn-help" class="interactive" position="0 0.12 0.03" width="0.5" height="0.12" color="#5CCAE8">
          <a-text value="HELP" align="center" width="3" position="0 0 0.01"></a-text>
        </a-plane>

        <a-plane id="btn-modules" class="interactive" position="0 -0.06 0.03" width="0.5" height="0.12" color="#B78A2D">
          <a-text value="MODULES" align="center" width="3" position="0 0 0.01"></a-text>
        </a-plane>

        <a-plane id="btn-exit-panel" class="interactive" position="0 -0.24 0.03" width="0.5" height="0.12" color="#CF2027">
          <a-text value="EXIT" align="center" width="3" position="0 0 0.01"></a-text>
        </a-plane>
      </a-plane>
    </a-entity>

    <a-entity id="help-card" visible="false" follow-camera>
      <a-plane width="0.8" height="1.2" color="#333" opacity="0.95" position="0 0 0.15" class="interactive">
        <a-text value="HELP" position="0 0.52 0.02" align="center" width="2" color="#FFF"></a-text>
        
        <a-plane id="btn-close-help" class="interactive" position="-0.35 0.52 0.03" width="0.1" height="0.1" color="red">
          <a-text value="X" align="center" width="2" position="0 0 0.01"></a-text>
        </a-plane>

        <a-text value="Link 1: Getting Started\nLink 2: User Guide\nLink 3: Tutorials\nLink 4: FAQ\nLink 5: Support" 
                position="0 0 0.02" align="center" width="1.5" color="#AAA" wrap-count="25"></a-text>
      </a-plane>
    </a-entity>

    <a-entity id="modules-card" visible="false" follow-camera>
      <a-plane width="0.8" height="1.2" color="#333" opacity="0.95" position="0 0 0.15" class="interactive">
        <a-text value="MODULES" position="0 0.52 0.02" align="center" width="2" color="#FFF"></a-text>
        
        <a-plane id="btn-close-modules" class="interactive" position="-0.35 0.52 0.03" width="0.1" height="0.1" color="red">
          <a-text value="X" align="center" width="2" position="0 0 0.01"></a-text>
        </a-plane>

        <a-text value="Module 1: Introduction\nModule 2: Basic Concepts\nModule 3: Advanced Topics\nModule 4: Projects\nModule 5: Resources" 
                position="0 0 0.02" align="center" width="1.5" color="#AAA" wrap-count="25"></a-text>
      </a-plane>
    </a-entity>

    <a-entity id="model-container" position="0 1.6 -2.5">
      <a-entity id="engineering-model" 
                scale="0.5 0.5 0.5" 
                rotation="0 0 0"
                remote-rotate-model
                scalable-model>
        <a-box position="0 0 0" width="1.2" height="0.8" depth="0.8" color="#F5F5F5" metalness="0.2" roughness="0.4"></a-box>
        <a-box position="0 0 0" width="1.21" height="0.81" depth="0.81" 
          material="color: #000000; wireframe: true; wireframeLinewidth: 3"></a-box>
        
        <a-cylinder position="0 0 0.42" radius="0.25" height="0.08" color="#F5F5F5" metalness="0.5" roughness="0.3"></a-cylinder>
        <a-cylinder position="0 0 0.42" radius="0.255" height="0.085"
          material="color: #000000; wireframe: true; wireframeLinewidth: 3"></a-cylinder>
        
        <a-box position="0.7 0 0" width="0.4" height="0.6" depth="0.6" color="#F5F5F5" metalness="0.2" roughness="0.4"></a-box>
        <a-box position="0.7 0 0" width="0.41" height="0.61" depth="0.61"
          material="color: #000000; wireframe: true; wireframeLinewidth: 3"></a-box>
        
        <a-cylinder position="0 0.5 0" radius="0.3" height="0.3" color="#F5F5F5" metalness="0.5" roughness="0.3"></a-cylinder>
        <a-cylinder position="0 0.5 0" radius="0.305" height="0.305"
          material="color: #000000; wireframe: true; wireframeLinewidth: 3"></a-cylinder>
        
        <a-box position="-0.5 -0.3 0.3" width="0.2" height="0.2" depth="0.2" color="#F5F5F5" metalness="0.2" roughness="0.4"></a-box>
        <a-box position="-0.5 -0.3 0.3" width="0.21" height="0.21" depth="0.21"
          material="color: #000000; wireframe: true; wireframeLinewidth: 3"></a-box>
      </a-entity>

      <a-text id="view-label" value="Front View" position="0 1.2 0" align="center" color="#2B2B88" width="5"></a-text>
    </a-entity>

    <a-entity id="rig" 
              movement-controls="speed: 0.15; controls: gamepad; fly: true">
              
      <a-entity id="camera" camera position="0 1.6 0" look-controls="pointerLockEnabled: false"></a-entity>

      <a-entity id="left-controller" 
                oculus-touch-controls="hand: left"
                vr-controller="hand: left"
                raycaster="objects: .interactive; far: 10; showLine: true; lineColor: cyan; lineOpacity: 0.75">
      </a-entity>

      <a-entity id="right-controller" 
                oculus-touch-controls="hand: right"
                vr-controller="hand: right"
                raycaster="objects: .interactive; far: 10; showLine: true; lineColor: red; lineOpacity: 0.75">
      </a-entity>
    </a-entity>

  </a-scene>

  <script>
    /**
     * AUDIO MANAGER
     * Handles background ambience and random sound effects
     */
    const AudioManager = {
      waves: new Audio('waves.mp3'),
      birds: new Audio('birds.mp3'),
      waves2: new Audio('waves2.mp3'),
      timers: [],

      init: function() {
        // Track 1: Waves (Continuous Loop)
        this.waves.loop = true;
        this.waves.volume = 0.4;

        // Track 2: Birds (Random intervals)
        this.birds.volume = 0.6;
        this.birds.addEventListener('ended', () => {
          this.scheduleNextBird();
        });

        // Track 3: Waves 2 (Complex random intervals + smooth fading)
        this.waves2.volume = 0; // Start silent for fade-in
        this.waves2.loop = true; // We manage play/pause manually, but loop ensures we don't run out of track during a long fade
      },

      start: function() {
        // Must be called after user interaction (Click "Enter Experience")
        this.waves.play().catch(e => console.log("Audio play error:", e));
        this.scheduleNextBird();
        this.scheduleWaves2();
      },

      stop: function() {
        this.waves.pause();
        this.birds.pause();
        this.waves2.pause();
        this.timers.forEach(t => clearTimeout(t));
        this.timers = [];
      },

      scheduleNextBird: function() {
        // Random interval between 8 and 25 seconds
        const delay = Math.random() * 17000 + 8000;
        const timer = setTimeout(() => {
          this.birds.currentTime = 0;
          this.birds.play().catch(e => {});
        }, delay);
        this.timers.push(timer);
      },

      scheduleWaves2: function() {
        // Random interval before the next "swell" starts (10s to 30s)
        const delay = Math.random() * 20000 + 10000;
        const timer = setTimeout(() => {
          this.playWaves2Swell();
        }, delay);
        this.timers.push(timer);
      },

      playWaves2Swell: function() {
        this.waves2.currentTime = 0;
        this.waves2.play().catch(e => {});
        
        // Random parameters for this specific swell
        const targetVolume = Math.random() * 0.5 + 0.3; // Peak volume between 0.3 and 0.8
        const duration = Math.random() * 10000 + 8000;  // How long this swell lasts
        const fadeInTime = Math.random() * 3000 + 2000; // 2-5s fade in
        const fadeOutTime = Math.random() * 3000 + 2000; // 2-5s fade out

        // 1. Fade In
        this.fadeAudio(this.waves2, 0, targetVolume, fadeInTime, () => {
          
          // 2. Wait for main duration
          const holdTimer = setTimeout(() => {
            
            // 3. Fade Out
            this.fadeAudio(this.waves2, targetVolume, 0, fadeOutTime, () => {
              this.waves2.pause();
              this.scheduleWaves2(); // Schedule the next cycle
            });

          }, duration);
          this.timers.push(holdTimer);
        });
      },

      // Helper for smooth volume transitions (no sudden changes)
      fadeAudio: function(audio, startVol, endVol, duration, callback) {
        const steps = 60; // 60fps updates
        const stepTime = duration / steps;
        const volStep = (endVol - startVol) / steps;
        let currentStep = 0;

        const interval = setInterval(() => {
          currentStep++;
          let newVol = startVol + (volStep * currentStep);
          // Clamp volume between 0 and 1
          newVol = Math.max(0, Math.min(1, newVol));
          audio.volume = newVol;

          if (currentStep >= steps) {
            clearInterval(interval);
            if (callback) callback();
          }
        }, stepTime);
        this.timers.push(interval);
      }
    };

    // Initialize Audio
    AudioManager.init();

    /* ---------------------------------------------------- */
    /* EXISTING LOGIC PRESERVED BELOW                       */
    /* ---------------------------------------------------- */

    const scene = document.querySelector('a-scene');
    const model = document.getElementById('engineering-model');
    
    scene.addEventListener('loaded', () => {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('overlay').style.display = 'flex';
    });

    document.getElementById('start-btn').addEventListener('click', () => {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('instructions').style.display = 'block';
      
      // START AUDIO SYSTEM HERE
      AudioManager.start();

      startViewCycle();
      
      // Auto-Enter VR Mode on Click
      if (scene.enterVR) {
        scene.enterVR();
      }
    });

    // View cycling system
    let views = [
      {name: 'Front View', rotation: {x: 0, y: 0, z: 0}},
      {name: 'Top View', rotation: {x: 90, y: 0, z: 0}},
      {name: 'Side View', rotation: {x: 0, y: 90, z: 0}},
      {name: 'Isometric View', rotation: {x: 35.26, y: 45, z: 0}}
    ];
    let viewIdx = 0;
    let viewCycleInterval = null;
    let isInteracting = false;
    let lastInteractionTime = 0;

    function startViewCycle() {
      if (viewCycleInterval) clearInterval(viewCycleInterval);
      viewCycleInterval = setInterval(() => {
        const now = Date.now();
        if (window.isLeftGripHeld) {
            lastInteractionTime = now;
            return; 
        }

        if (!isInteracting && (now - lastInteractionTime > 10000 || lastInteractionTime === 0)) {
          viewIdx = (viewIdx + 1) % views.length;
          const view = views[viewIdx];
          const label = document.getElementById('view-label');
          
          label.setAttribute('value', view.name);
          model.setAttribute('animation', {
            property: 'rotation',
            to: `${view.rotation.x} ${view.rotation.y} ${view.rotation.z}`,
            dur: 1200,
            easing: 'easeInOutQuad'
          });
        }
      }, 3000);
    }

    function stopViewCycle() {
      isInteracting = true;
      lastInteractionTime = Date.now();
      document.getElementById('view-label').setAttribute('value', 'Interactive Mode');
      document.getElementById('view-label').setAttribute('color', '#CF2027');
    }

    function resumeViewCycle() {
      isInteracting = false;
      lastInteractionTime = Date.now();
      document.getElementById('view-label').setAttribute('color', '#2B2B88');
    }

    scene.addEventListener('stop-view-cycle', stopViewCycle);
    scene.addEventListener('resume-view-cycle', resumeViewCycle);

    // UI Panel Controls
    document.getElementById('toggle-panel-btn').addEventListener('click', () => {
      const p = document.getElementById('control-panel');
      const btn = document.getElementById('toggle-panel-btn');
      const isVisible = p.getAttribute('visible');
      
      p.setAttribute('visible', !isVisible);
      btn.setAttribute('visible', isVisible);
    });

    document.getElementById('btn-close').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('control-panel').setAttribute('visible', false);
      document.getElementById('toggle-panel-btn').setAttribute('visible', true);
    });

    document.getElementById('btn-help').addEventListener('click', (e) => {
      e.stopPropagation();
      const panel = document.getElementById('control-panel');
      if (panel.getAttribute('visible')) {
        const helpCard = document.getElementById('help-card');
        helpCard.setAttribute('visible', true);
        panel.setAttribute('visible', false);
        document.getElementById('toggle-panel-btn').setAttribute('visible', false);
        document.getElementById('modules-card').setAttribute('visible', false);
      }
    });

    document.getElementById('btn-modules').addEventListener('click', (e) => {
      e.stopPropagation();
      const panel = document.getElementById('control-panel');
      if (panel.getAttribute('visible')) {
        const modulesCard = document.getElementById('modules-card');
        modulesCard.setAttribute('visible', true);
        panel.setAttribute('visible', false);
        document.getElementById('toggle-panel-btn').setAttribute('visible', false);
        document.getElementById('help-card').setAttribute('visible', false);
      }
    });

    document.getElementById('btn-close-help').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('help-card').setAttribute('visible', false);
      document.getElementById('toggle-panel-btn').setAttribute('visible', true);
    });

    document.getElementById('btn-close-modules').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('modules-card').setAttribute('visible', false);
      document.getElementById('toggle-panel-btn').setAttribute('visible', true);
    });

    document.getElementById('btn-exit-panel').addEventListener('click', (e) => {
      e.stopPropagation();
      // STOP AUDIO ON EXIT
      AudioManager.stop();
      
      scene.exitVR();
      document.getElementById('overlay').style.display = 'flex';
      document.getElementById('instructions').style.display = 'none';
      document.getElementById('control-panel').setAttribute('visible', false);
      document.getElementById('toggle-panel-btn').setAttribute('visible', true);
      document.getElementById('help-card').setAttribute('visible', false);
      document.getElementById('modules-card').setAttribute('visible', false);
      if (viewCycleInterval) clearInterval(viewCycleInterval);
    });

    document.getElementById('exit-btn').addEventListener('click', () => {
      // STOP AUDIO ON EXIT
      AudioManager.stop();

      scene.exitVR();
      document.getElementById('overlay').style.display = 'flex';
      document.getElementById('instructions').style.display = 'none';
      if (viewCycleInterval) clearInterval(viewCycleInterval);
    });

    // Desktop mouse controls
    let isDragging = false;
    let previousMouseX = 0;
    let previousMouseY = 0;
    let mouseDownOnModel = false;

    model.addEventListener('mousedown', (e) => {
      mouseDownOnModel = true;
      isDragging = true;
      previousMouseX = e.clientX;
      previousMouseY = e.clientY;
      stopViewCycle();
      e.preventDefault();
      e.stopPropagation();
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        mouseDownOnModel = false;
        resumeViewCycle();
      }
    });
    
    document.addEventListener('mousemove', (e) => {
      if (!isDragging || !mouseDownOnModel) return;
      
      e.preventDefault();
      e.stopPropagation();
      
      const deltaX = e.clientX - previousMouseX;
      const deltaY = e.clientY - previousMouseY;
      
      previousMouseX = e.clientX;
      previousMouseY = e.clientY;
      
      model.object3D.rotation.y += deltaX * 0.01;
      model.object3D.rotation.x += deltaY * 0.01;
    });

    const camera = document.getElementById('camera');
    model.addEventListener('mouseenter', () => {
      if (camera.components['look-controls']) {
        camera.components['look-controls'].pause();
      }
    });
    
    model.addEventListener('mouseleave', () => {
      if (!isDragging && camera.components['look-controls']) {
        camera.components['look-controls'].play();
      }
    });

    // Desktop scroll wheel for zoom
    window.addEventListener('wheel', (e) => {
      e.preventDefault();
      const scalable = model.components['scalable-model'];
      if (scalable) {
        if (e.deltaY < 0) {
          scalable.scaleUp();
        } else {
          scalable.scaleDown();
        }
      }
    }, { passive: false });
  </script>
</body>
</html>