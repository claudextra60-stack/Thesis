<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Engineering Drawing VR - Fixed Controls</title>
  
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
  
  <style>
    /* BASIC UI STYLES */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: sans-serif; overflow: hidden; }

    #loading {
      position: fixed; inset: 0; background: #2B2B88; z-index: 999;
      display: flex; justify-content: center; align-items: center;
      color: white; font-size: 2rem; font-weight: bold;
    }
    
    #overlay {
      position: fixed; inset: 0; z-index: 100;
      background: rgba(255,255,255,0.9);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }

    .btn {
      padding: 20px 60px; font-size: 1.5rem; background: #CF2027; color: white;
      border: none; border-radius: 10px; cursor: pointer; margin-top: 20px;
    }
    .btn:hover { background: #2B2B88; }
  </style>

  <script>
    // --- COMPONENT: Pinch to Click ---
    // Converts Hand Pinch into a standard click event
    AFRAME.registerComponent('pinch-to-click', {
      init: function () {
        this.pinched = false;
        // Listen for Quest pinch events
        this.el.addEventListener('pinchstarted', this.onPinch.bind(this));
        this.el.addEventListener('pinchended', this.onRelease.bind(this));
      },
      onPinch: function (evt) {
        if (this.pinched) return;
        this.pinched = true;
        
        // Visual feedback
        this.el.setAttribute('raycaster', 'lineColor', '#00FF00'); 

        // Find what we are pointing at
        const raycaster = this.el.components.raycaster;
        const intersected = raycaster.intersectedEls;
        
        if (intersected.length > 0) {
          const target = intersected[0];
          console.log("Pinch clicked on:", target.id);
          // Emit standard click
          target.emit('click');
          // Emit triggerdown for grabbing
          this.el.emit('triggerdown', { target: target });
        }
      },
      onRelease: function () {
        this.pinched = false;
        // Reset color
        const defaultColor = this.el.id === 'left-hand' ? '#00FFFF' : '#FF0000';
        this.el.setAttribute('raycaster', 'lineColor', defaultColor);
        this.el.emit('triggerup');
      }
    });

    // --- COMPONENT: Follow Camera ---
    // Makes the panel follow the user physically
    AFRAME.registerComponent('follow-camera', {
      tick: function () {
        if (!this.el.object3D.visible) return;

        const camera = document.getElementById('camera');
        const rig = document.getElementById('rig');
        if (!camera || !rig) return;

        // Get camera world position
        const camPos = new THREE.Vector3();
        camera.object3D.getWorldPosition(camPos);
        
        // Get camera world rotation (Y axis only)
        const camRot = new THREE.Euler();
        camRot.setFromQuaternion(camera.object3D.quaternion, 'YXZ');

        // Calculate target position (in front of camera, slightly down)
        // We offset by 0.7m forward and 0.4m down
        const distance = 0.7;
        const targetX = camPos.x - Math.sin(camRot.y) * distance;
        const targetZ = camPos.z - Math.cos(camRot.y) * distance;
        const targetY = camPos.y - 0.4;

        // Smoothly interpolate current panel position to target
        this.el.object3D.position.lerp(new THREE.Vector3(targetX, targetY, targetZ), 0.1);
        
        // Make panel face the user
        this.el.object3D.lookAt(camPos.x, camPos.y, camPos.z);
      }
    });
  </script>
</head>

<body>
  <div id="loading">Loading VR...</div>

  <div id="overlay" style="display: none;">
    <h1>VR Engineering Visualizer</h1>
    <p>Desktop: Use Mouse to Click & Drag. WASD to Move.</p>
    <p>VR: Pinch to Click. Pinch & Drag Model.</p>
    <button class="btn" id="start-btn">ENTER EXPERIENCE</button>
  </div>

  <a-scene id="vr-scene" 
           background="color: #E8F4F8" 
           cursor="rayOrigin: mouse" 
           raycaster="objects: .interactive">

    <a-assets>
      <img id="wall-tex" src="https://cdn.architextures.org/textures/23/10/plain-blue-sheer-twinbru-textiles-1yeo48.jpg" crossorigin="anonymous">
      <img id="floor-tex" src="https://cdn.architextures.org/textures/23/7/plain-green-texture-none-twinbru-textiles-9cbkkg.jpg" crossorigin="anonymous">
    </a-assets>

    <a-plane position="0 0 0" rotation="-90 0 0" width="20" height="20" src="#floor-tex" repeat="4 4" color="#888"></a-plane>
    <a-plane position="0 3 -10" width="20" height="6" src="#wall-tex" repeat="4 2"></a-plane>
    <a-plane position="-10 3 0" rotation="0 90 0" width="20" height="6" src="#wall-tex" repeat="4 2"></a-plane>
    <a-plane position="10 3 0" rotation="0 -90 0" width="20" height="6" src="#wall-tex" repeat="4 2"></a-plane>
    
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; position: 1 5 2; intensity: 0.8"></a-entity>

    <a-plane id="exit-btn" class="interactive" position="0 2 9.8" rotation="0 180 0" width="2" height="0.8" color="#CF2027">
      <a-text value="EXIT VR" align="center" width="6"></a-text>
    </a-plane>

    <a-circle id="toggle-panel-btn" class="interactive" position="-0.5 1.5 -1" radius="0.1" color="#2B2B88" 
              animation="property: scale; from: 1 1 1; to: 1.1 1.1 1.1; dir: alternate; loop: true; dur: 1000">
      <a-text value="MENU" align="center" width="2"></a-text>
    </a-circle>

    <a-entity id="control-panel" visible="false" follow-camera>
      <a-plane width="1" height="0.6" color="#222" opacity="0.9">
        <a-text value="CONTROLS" position="0 0.25 0.01" align="center"></a-text>
        
        <a-plane id="btn-close" class="interactive" position="0.4 0.25 0.02" width="0.1" height="0.1" color="red">
          <a-text value="X" align="center"></a-text>
        </a-plane>

        <a-plane id="btn-view" class="interactive" position="0 0.1 0.02" width="0.4" height="0.1" color="#5CCAE8">
          <a-text value="Next View" align="center" width="2"></a-text>
        </a-plane>

        <a-plane id="btn-reset" class="interactive" position="0 -0.1 0.02" width="0.4" height="0.1" color="#B78A2D">
          <a-text value="Reset Model" align="center" width="2"></a-text>
        </a-plane>

        <a-text value="Walk around to move" position="0 -0.25 0.02" align="center" width="1.5" color="#aaa"></a-text>
      </a-plane>
    </a-entity>

    <a-entity id="model-container" position="0 1.6 -2">
      <a-entity id="engineering-model" class="interactive" scale="0.5 0.5 0.5">
        <a-box color="#DDD" width="1" height="1" depth="1"></a-box>
        <a-cylinder color="#333" radius="0.2" height="1.2"></a-cylinder>
        <a-sphere color="red" radius="0.1" position="0.5 0.5 0.5"></a-sphere>
      </a-entity>
      <a-text id="view-label" value="Front View" position="0 0.8 0" align="center" color="#2B2B88" width="4"></a-text>
    </a-entity>

    <a-entity id="rig" movement-controls="speed: 0.1">
      <a-entity id="camera" camera position="0 1.6 0" look-controls="pointerLockEnabled: false"></a-entity>

      <a-entity id="left-hand" 
        hand-tracking-controls="hand: left"
        pinch-to-click
        raycaster="objects: .interactive; far: 5; showLine: true; lineColor: #00FFFF; lineOpacity: 0.8">
      </a-entity>

      <a-entity id="right-hand" 
        hand-tracking-controls="hand: right"
        pinch-to-click
        raycaster="objects: .interactive; far: 5; showLine: true; lineColor: #FF0000; lineOpacity: 0.8">
      </a-entity>

      <a-entity laser-controls="hand: left" raycaster="objects: .interactive; far: 5; lineColor: #00FFFF"></a-entity>
      <a-entity laser-controls="hand: right" raycaster="objects: .interactive; far: 5; lineColor: #FF0000"></a-entity>
    </a-entity>

  </a-scene>

  <script>
    // --- APP LOGIC ---
    const scene = document.querySelector('a-scene');
    const model = document.getElementById('engineering-model');
    
    // Hide loading when ready
    scene.addEventListener('loaded', () => {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('overlay').style.display = 'flex';
    });

    // Start Button
    document.getElementById('start-btn').addEventListener('click', () => {
      document.getElementById('overlay').style.display = 'none';
      if (scene.enterVR) scene.enterVR();
    });

    // Interaction State
    let views = [
      {r: {x:0, y:0, z:0}, text: "Front View"},
      {r: {x:90, y:0, z:0}, text: "Top View"},
      {r: {x:0, y:90, z:0}, text: "Side View"},
      {r: {x:35, y:45, z:0}, text: "Iso View"}
    ];
    let viewIdx = 0;

    // Click Handlers
    document.getElementById('toggle-panel-btn').addEventListener('click', () => {
      const p = document.getElementById('control-panel');
      p.setAttribute('visible', !p.getAttribute('visible'));
    });

    document.getElementById('btn-close').addEventListener('click', () => {
      document.getElementById('control-panel').setAttribute('visible', false);
    });

    document.getElementById('btn-view').addEventListener('click', () => {
      viewIdx = (viewIdx + 1) % views.length;
      updateView();
    });

    document.getElementById('btn-reset').addEventListener('click', () => {
      model.setAttribute('rotation', '0 0 0');
      viewIdx = 0;
      updateView();
    });

    document.getElementById('exit-btn').addEventListener('click', () => {
      scene.exitVR();
      document.getElementById('overlay').style.display = 'flex';
    });

    function updateView() {
      const v = views[viewIdx];
      model.setAttribute('animation', `property: rotation; to: ${v.r.x} ${v.r.y} ${v.r.z}; dur: 500`);
      document.getElementById('view-label').setAttribute('value', v.text);
    }

    // --- DRAG TO ROTATE (PC & VR) ---
    // This handles both Mouse Drag and Pinch Drag
    let isDragging = false;
    let startX = 0, startY = 0;
    let startRot = {x:0, y:0};

    // PC Mouse Events on Model
    model.addEventListener('mousedown', (e) => {
      isDragging = true;
      startX = e.detail.cursorEl ? 0 : e.clientX; // Simplified for PC
      startY = e.detail.cursorEl ? 0 : e.clientY;
      startRot = Object.assign({}, model.getAttribute('rotation'));
    });

    window.addEventListener('mouseup', () => isDragging = false);
    
    window.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      // PC Mouse rotation logic
      if (e.buttons === 1) { // Left click only
        model.object3D.rotation.y += e.movementX * 0.01;
        model.object3D.rotation.x += e.movementY * 0.01;
      }
    });

    // VR Pinch Drag Events
    // Listening for the custom 'triggerdown' emitted by our component
    const hands = [document.getElementById('left-hand'), document.getElementById('right-hand')];
    
    hands.forEach(hand => {
      let handStartRot = null;
      let modelStartRot = null;

      hand.addEventListener('triggerdown', (e) => {
        if(e.detail.target === model || e.detail.target.closest('#engineering-model')) {
          handStartRot = hand.object3D.rotation.clone();
          modelStartRot = model.object3D.rotation.clone();
        }
      });

      hand.addEventListener('triggerup', () => {
        handStartRot = null;
      });

      // Update loop for VR rotation
      setInterval(() => {
        if (handStartRot) {
          const currentHandRot = hand.object3D.rotation;
          const dy = (currentHandRot.y - handStartRot.y);
          const dx = (currentHandRot.x - handStartRot.x);
          
          model.object3D.rotation.y = modelStartRot.y + dy * 2;
          model.object3D.rotation.x = modelStartRot.x + dx * 2;
        }
      }, 16);
    });

  </script>
</body>
</html>