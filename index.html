<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Engineering Drawing VR - Fixed Controls</title>
  
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: sans-serif; overflow: hidden; }

    #loading {
      position: fixed; inset: 0; background: #2B2B88; z-index: 999;
      display: flex; justify-content: center; align-items: center;
      color: white; font-size: 2rem; font-weight: bold;
    }
    
    #overlay {
      position: fixed; inset: 0; z-index: 100;
      background: rgba(255,255,255,0.9);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }

    .btn {
      padding: 20px 60px; font-size: 1.5rem; background: #CF2027; color: white;
      border: none; border-radius: 10px; cursor: pointer; margin-top: 20px;
    }
    .btn:hover { background: #2B2B88; }

    #instructions {
      position: fixed; bottom: 20px; left: 20px; z-index: 50;
      background: rgba(0,0,0,0.7); color: white; padding: 15px;
      border-radius: 8px; font-size: 14px;
    }
  </style>

  <script>
    AFRAME.registerComponent('pinch-to-click', {
      init: function () {
        this.pinched = false;
        this.el.addEventListener('pinchstarted', this.onPinch.bind(this));
        this.el.addEventListener('pinchended', this.onRelease.bind(this));
      },
      onPinch: function (evt) {
        if (this.pinched) return;
        this.pinched = true;
        
        const raycaster = this.el.components.raycaster;
        const intersected = raycaster.intersectedEls;
        
        if (intersected.length > 0) {
          const target = intersected[0];
          console.log("Pinch clicked on:", target.id);
          target.emit('click');
          this.el.emit('triggerdown', { target: target });
        }
      },
      onRelease: function () {
        this.pinched = false;
        this.el.emit('triggerup');
      }
    });

    AFRAME.registerComponent('follow-camera', {
      tick: function () {
        if (!this.el.object3D.visible) return;

        const camera = document.getElementById('camera');
        if (!camera) return;

        const camPos = new THREE.Vector3();
        camera.object3D.getWorldPosition(camPos);
        
        const camRot = new THREE.Euler();
        camRot.setFromQuaternion(camera.object3D.quaternion, 'YXZ');

        const distance = 0.7;
        const targetX = camPos.x - Math.sin(camRot.y) * distance;
        const targetZ = camPos.z - Math.cos(camRot.y) * distance;
        const targetY = camPos.y - 0.4;

        this.el.object3D.position.lerp(new THREE.Vector3(targetX, targetY, targetZ), 0.1);
        this.el.object3D.lookAt(camPos.x, camPos.y, camPos.z);
      }
    });
  </script>
</head>

<body>
  <div id="loading">Loading VR...</div>

  <div id="overlay" style="display: none;">
    <h1>VR Engineering Visualizer</h1>
    <p>Desktop: Left Click + Drag to Rotate. Scroll Wheel to Zoom. WASD to Move.</p>
    <p>VR: Pinch to Click. Pinch & Drag Model.</p>
    <button class="btn" id="start-btn">ENTER EXPERIENCE</button>
  </div>

  <div id="instructions" style="display: none;">
    <strong>Controls:</strong><br>
    Left Click + Drag: Rotate Model<br>
    Scroll Wheel: Zoom In/Out<br>
    WASD: Move Around
  </div>

  <a-scene id="vr-scene" 
           background="color: #E8F4F8" 
           cursor="rayOrigin: mouse" 
           raycaster="objects: .interactive, .grabbable">

    <a-assets>
      <img id="wall-tex" src="https://cdn.architextures.org/textures/23/7/plain-green-sheer-none-twinbru-textiles-12eva5.jpg" crossorigin="anonymous">
      <img id="floor-tex" src="https://cdn.architextures.org/textures/24/5/sand-j9sy8a.jpg" crossorigin="anonymous">
      <img id="ceiling-tex" src="https://cdn.architextures.org/textures/23/8/oatmeal-loop-pile-carpet-cubic-chjny5.jpg" crossorigin="anonymous">
    </a-assets>

    <a-plane position="0 0 0" rotation="-90 0 0" width="20" height="20" src="#floor-tex" repeat="10 10" color="#FFF"></a-plane>
    <a-plane position="0 6 0" rotation="90 0 0" width="20" height="20" src="#ceiling-tex" repeat="10 10" color="#FFF"></a-plane>
    <a-plane position="0 3 -10" width="20" height="6" src="#wall-tex" repeat="10 3" color="#FFF"></a-plane>
    <a-plane position="-10 3 0" rotation="0 90 0" width="20" height="6" src="#wall-tex" repeat="10 3" color="#FFF"></a-plane>
    <a-plane position="10 3 0" rotation="0 -90 0" width="20" height="6" src="#wall-tex" repeat="10 3" color="#FFF"></a-plane>
    <a-plane position="0 3 10" rotation="0 180 0" width="20" height="6" src="#wall-tex" repeat="10 3" color="#FFF"></a-plane>
    
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; position: 1 5 2; intensity: 0.8"></a-entity>

    <a-plane id="exit-btn" class="interactive" position="0 2 9.8" rotation="0 180 0" width="2" height="0.8" color="#CF2027">
      <a-text value="EXIT VR" align="center" width="6" color="#FFF"></a-text>
    </a-plane>

    <a-circle id="toggle-panel-btn" class="interactive" visible="true" follow-camera radius="0.08" color="#2B2B88" 
              animation="property: scale; from: 1 1 1; to: 1.1 1.1 1.1; dir: alternate; loop: true; dur: 1000">
      <a-text value="MENU" align="center" width="1.2" position="0 0 0.01"></a-text>
    </a-circle>

    <a-entity id="control-panel" visible="false" follow-camera>
      <a-plane width="1.2" height="0.8" color="#222" opacity="0.9" class="interactive">
        <a-text value="CONTROLS" position="0 0.32 0.01" align="center" width="2.5" color="#FFF"></a-text>
        
        <a-plane id="btn-close" class="interactive" position="0.5 0.32 0.02" width="0.12" height="0.12" color="red">
          <a-text value="X" align="center" width="2" position="0 0 0.01"></a-text>
        </a-plane>

        <a-plane id="btn-help" class="interactive" position="0 0.12 0.02" width="0.5" height="0.12" color="#5CCAE8">
          <a-text value="HELP" align="center" width="3" position="0 0 0.01"></a-text>
        </a-plane>

        <a-plane id="btn-modules" class="interactive" position="0 -0.06 0.02" width="0.5" height="0.12" color="#B78A2D">
          <a-text value="MODULES" align="center" width="3" position="0 0 0.01"></a-text>
        </a-plane>

        <a-plane id="btn-exit-panel" class="interactive" position="0 -0.24 0.02" width="0.5" height="0.12" color="#CF2027">
          <a-text value="EXIT" align="center" width="3" position="0 0 0.01"></a-text>
        </a-plane>
      </a-plane>
    </a-entity>

    <a-entity id="help-card" visible="false" follow-camera>
      <a-plane width="0.8" height="1.2" color="#333" opacity="0.95" position="0 0 0.15" class="interactive">
        <a-text value="HELP" position="0 0.52 0.01" align="center" width="2" color="#FFF"></a-text>
        
        <a-plane id="btn-close-help" class="interactive" position="0.35 0.52 0.02" width="0.1" height="0.1" color="red">
          <a-text value="X" align="center" width="2" position="0 0 0.01"></a-text>
        </a-plane>

        <a-text value="Link 1: Getting Started\nLink 2: User Guide\nLink 3: Tutorials\nLink 4: FAQ\nLink 5: Support" 
                position="0 0 0.01" align="center" width="1.5" color="#AAA" wrap-count="25"></a-text>
      </a-plane>
    </a-entity>

    <a-entity id="modules-card" visible="false" follow-camera>
      <a-plane width="0.8" height="1.2" color="#333" opacity="0.95" position="0 0 0.15" class="interactive">
        <a-text value="MODULES" position="0 0.52 0.01" align="center" width="2" color="#FFF"></a-text>
        
        <a-plane id="btn-close-modules" class="interactive" position="0.35 0.52 0.02" width="0.1" height="0.1" color="red">
          <a-text value="X" align="center" width="2" position="0 0 0.01"></a-text>
        </a-plane>

        <a-text value="Module 1: Introduction\nModule 2: Basic Concepts\nModule 3: Advanced Topics\nModule 4: Projects\nModule 5: Resources" 
                position="0 0 0.01" align="center" width="1.5" color="#AAA" wrap-count="25"></a-text>
      </a-plane>
    </a-entity>

    <a-entity id="model-container" position="0 1.6 -2.5">
      <a-entity id="engineering-model" scale="0.4 0.4 0.4" class="interactive grabbable">
        <a-box position="0 0 0" width="1.2" height="0.8" depth="0.8" color="#F5F5F5" metalness="0.2" roughness="0.4"></a-box>
        <a-box position="0 0 0" width="1.21" height="0.81" depth="0.81" 
          material="color: #000000; wireframe: true; wireframeLinewidth: 3"></a-box>
        
        <a-cylinder position="0 0 0.42" radius="0.25" height="0.08" color="#F5F5F5" metalness="0.5" roughness="0.3"></a-cylinder>
        <a-cylinder position="0 0 0.42" radius="0.255" height="0.085"
          material="color: #000000; wireframe: true; wireframeLinewidth: 3"></a-cylinder>
        
        <a-box position="0.7 0 0" width="0.4" height="0.6" depth="0.6" color="#F5F5F5" metalness="0.2" roughness="0.4"></a-box>
        <a-box position="0.7 0 0" width="0.41" height="0.61" depth="0.61"
          material="color: #000000; wireframe: true; wireframeLinewidth: 3"></a-box>
        
        <a-cylinder position="0 0.5 0" radius="0.3" height="0.3" color="#F5F5F5" metalness="0.5" roughness="0.3"></a-cylinder>
        <a-cylinder position="0 0.5 0" radius="0.305" height="0.305"
          material="color: #000000; wireframe: true; wireframeLinewidth: 3"></a-cylinder>
        
        <a-box position="-0.5 -0.3 0.3" width="0.2" height="0.2" depth="0.2" color="#F5F5F5" metalness="0.2" roughness="0.4"></a-box>
        <a-box position="-0.5 -0.3 0.3" width="0.21" height="0.21" depth="0.21"
          material="color: #000000; wireframe: true; wireframeLinewidth: 3"></a-box>
        
        <a-sphere position="0.6 0.4 0.4" radius="0.04" color="#000000"></a-sphere>
        <a-sphere position="0.6 0.4 -0.4" radius="0.04" color="#000000"></a-sphere>
        <a-sphere position="0.6 -0.4 0.4" radius="0.04" color="#000000"></a-sphere>
        <a-sphere position="0.6 -0.4 -0.4" radius="0.04" color="#000000"></a-sphere>
        <a-sphere position="-0.6 0.4 0.4" radius="0.04" color="#000000"></a-sphere>
        <a-sphere position="-0.6 0.4 -0.4" radius="0.04" color="#000000"></a-sphere>
        <a-sphere position="-0.6 -0.4 0.4" radius="0.04" color="#000000"></a-sphere>
        <a-sphere position="-0.6 -0.4 -0.4" radius="0.04" color="#000000"></a-sphere>
        <a-sphere position="0.9 0.3 0.3" radius="0.04" color="#000000"></a-sphere>
        <a-sphere position="0.9 0.3 -0.3" radius="0.04" color="#000000"></a-sphere>
        <a-sphere position="0.9 -0.3 0.3" radius="0.04" color="#000000"></a-sphere>
        <a-sphere position="0.9 -0.3 -0.3" radius="0.04" color="#000000"></a-sphere>
      </a-entity>

      <a-text id="view-label" value="Front View" position="0 1.2 0" align="center" color="#2B2B88" width="5"></a-text>
    </a-entity>

    <a-entity id="rig" movement-controls="speed: 0.1">
      <a-entity id="camera" camera position="0 1.6 0" look-controls="pointerLockEnabled: false"></a-entity>

      <a-entity id="left-hand" 
        hand-tracking-controls="hand: left"
        pinch-to-click
        raycaster="objects: .interactive, .grabbable; far: 5; showLine: true; lineColor: #00FFFF; lineOpacity: 0.8">
      </a-entity>

      <a-entity id="right-hand" 
        hand-tracking-controls="hand: right"
        pinch-to-click
        raycaster="objects: .interactive, .grabbable; far: 5; showLine: true; lineColor: #FF0000; lineOpacity: 0.8">
      </a-entity>

      <a-entity laser-controls="hand: left" raycaster="objects: .interactive, .grabbable; far: 5; lineColor: #00FFFF; lineOpacity: 0"></a-entity>
      <a-entity laser-controls="hand: right" raycaster="objects: .interactive, .grabbable; far: 5; lineColor: #FF0000; lineOpacity: 0"></a-entity>
    </a-entity>

  </a-scene>

  <script>
    const scene = document.querySelector('a-scene');
    const model = document.getElementById('engineering-model');
    
    scene.addEventListener('loaded', () => {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('overlay').style.display = 'flex';
    });

    document.getElementById('start-btn').addEventListener('click', () => {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('instructions').style.display = 'block';
      if (scene.enterVR) scene.enterVR();
      startViewCycle();
    });

    let views = [
      {name: 'Front View', rotation: {x: 0, y: 0, z: 0}},
      {name: 'Top View', rotation: {x: 90, y: 0, z: 0}},
      {name: 'Side View', rotation: {x: 0, y: 90, z: 0}},
      {name: 'Isometric View', rotation: {x: 35.26, y: 45, z: 0}}
    ];
    let viewIdx = 0;
    let viewCycleInterval = null;
    let isInteracting = false;
    let lastInteractionTime = 0;

    function startViewCycle() {
      if (viewCycleInterval) clearInterval(viewCycleInterval);
      viewCycleInterval = setInterval(() => {
        const now = Date.now();
        if (!isInteracting && (now - lastInteractionTime > 10000 || lastInteractionTime === 0)) {
          viewIdx = (viewIdx + 1) % views.length;
          const view = views[viewIdx];
          const label = document.getElementById('view-label');
          
          label.setAttribute('value', view.name);
          model.setAttribute('animation', {
            property: 'rotation',
            to: `${view.rotation.x} ${view.rotation.y} ${view.rotation.z}`,
            dur: 1200,
            easing: 'easeInOutQuad'
          });
        }
      }, 3000);
    }

    function stopViewCycle() {
      isInteracting = true;
      lastInteractionTime = Date.now();
      document.getElementById('view-label').setAttribute('value', 'Interactive Mode');
      document.getElementById('view-label').setAttribute('color', '#CF2027');
    }

    function resumeViewCycle() {
      isInteracting = false;
      lastInteractionTime = Date.now();
      document.getElementById('view-label').setAttribute('color', '#2B2B88');
    }

    document.getElementById('toggle-panel-btn').addEventListener('click', () => {
      const p = document.getElementById('control-panel');
      const btn = document.getElementById('toggle-panel-btn');
      const isVisible = p.getAttribute('visible');
      
      p.setAttribute('visible', !isVisible);
      btn.setAttribute('visible', isVisible);
    });

    document.getElementById('btn-close').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('control-panel').setAttribute('visible', false);
      document.getElementById('toggle-panel-btn').setAttribute('visible', true);
    });

    document.getElementById('btn-help').addEventListener('click', (e) => {
      e.stopPropagation();
      const panel = document.getElementById('control-panel');
      if (panel.getAttribute('visible')) {
        const helpCard = document.getElementById('help-card');
        helpCard.setAttribute('visible', true);
        panel.setAttribute('visible', false);
        document.getElementById('toggle-panel-btn').setAttribute('visible', false);
        document.getElementById('modules-card').setAttribute('visible', false);
      }
    });

    document.getElementById('btn-modules').addEventListener('click', (e) => {
      e.stopPropagation();
      const panel = document.getElementById('control-panel');
      if (panel.getAttribute('visible')) {
        const modulesCard = document.getElementById('modules-card');
        modulesCard.setAttribute('visible', true);
        panel.setAttribute('visible', false);
        document.getElementById('toggle-panel-btn').setAttribute('visible', false);
        document.getElementById('help-card').setAttribute('visible', false);
      }
    });

    document.getElementById('btn-close-help').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('help-card').setAttribute('visible', false);
      document.getElementById('toggle-panel-btn').setAttribute('visible', true);
    });

    document.getElementById('btn-close-modules').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('modules-card').setAttribute('visible', false);
      document.getElementById('toggle-panel-btn').setAttribute('visible', true);
    });

    document.getElementById('btn-exit-panel').addEventListener('click', (e) => {
      e.stopPropagation();
      scene.exitVR();
      document.getElementById('overlay').style.display = 'flex';
      document.getElementById('instructions').style.display = 'none';
      document.getElementById('control-panel').setAttribute('visible', false);
      document.getElementById('toggle-panel-btn').setAttribute('visible', true);
      document.getElementById('help-card').setAttribute('visible', false);
      document.getElementById('modules-card').setAttribute('visible', false);
      if (viewCycleInterval) clearInterval(viewCycleInterval);
    });

    document.getElementById('exit-btn').addEventListener('click', () => {
      scene.exitVR();
      document.getElementById('overlay').style.display = 'flex';
      document.getElementById('instructions').style.display = 'none';
      if (viewCycleInterval) clearInterval(viewCycleInterval);
    });

    let isDragging = false;
    let previousMouseX = 0;
    let previousMouseY = 0;
    let mouseDownOnModel = false;

    model.addEventListener('mousedown', (e) => {
      mouseDownOnModel = true;
      isDragging = true;
      previousMouseX = e.clientX;
      previousMouseY = e.clientY;
      stopViewCycle();
      e.preventDefault();
      e.stopPropagation();
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        mouseDownOnModel = false;
        resumeViewCycle();
      }
    });
    
    document.addEventListener('mousemove', (e) => {
      if (!isDragging || !mouseDownOnModel) return;
      
      e.preventDefault();
      e.stopPropagation();
      
      const deltaX = e.clientX - previousMouseX;
      const deltaY = e.clientY - previousMouseY;
      
      previousMouseX = e.clientX;
      previousMouseY = e.clientY;
      
      model.object3D.rotation.y += deltaX * 0.01;
      model.object3D.rotation.x += deltaY * 0.01;
    });

    const camera = document.getElementById('camera');
    model.addEventListener('mouseenter', () => {
      if (camera.components['look-controls']) {
        camera.components['look-controls'].pause();
      }
    });
    
    model.addEventListener('mouseleave', () => {
      if (!isDragging && camera.components['look-controls']) {
        camera.components['look-controls'].play();
      }
    });

    window.addEventListener('wheel', (e) => {
      e.preventDefault();
      const currentScale = model.getAttribute('scale');
      const scaleFactor = e.deltaY > 0 ? 0.9 : 1.1;
      let newScale = currentScale.x * scaleFactor;
      newScale = Math.max(0.1, Math.min(2.0, newScale));
      model.setAttribute('scale', `${newScale} ${newScale} ${newScale}`);
    }, { passive: false });

    const hands = [document.getElementById('left-hand'), document.getElementById('right-hand')];
    
    hands.forEach(hand => {
      let handStartRot = null;
      let modelStartRot = null;
      let isGrabbingModel = false;

      hand.addEventListener('triggerdown', (e) => {
        const raycaster = hand.components.raycaster;
        if (raycaster && raycaster.intersectedEls && raycaster.intersectedEls.length > 0) {
          const target = raycaster.intersectedEls[0];
          
          if (target.id === 'engineering-model' || target.closest('#engineering-model')) {
            isGrabbingModel = true;
            handStartRot = new THREE.Euler().copy(hand.object3D.rotation);
            modelStartRot = new THREE.Euler().copy(model.object3D.rotation);
            stopViewCycle();
          }
        }
      });

      hand.addEventListener('triggerup', () => {
        if (isGrabbingModel) {
          isGrabbingModel = false;
          handStartRot = null;
          modelStartRot = null;
          resumeViewCycle();
        }
      });

      setInterval(() => {
        if (isGrabbingModel && handStartRot && modelStartRot) {
          const currentHandRot = hand.object3D.rotation;
          const deltaY = (currentHandRot.y - handStartRot.y);
          const deltaX = (currentHandRot.x - handStartRot.x);
          
          model.object3D.rotation.y = modelStartRot.y + deltaY * 2;
          model.object3D.rotation.x = modelStartRot.x - deltaX * 2;
        }
      }, 16);
    });

    scene.addEventListener('loaded', () => {
      const leftController = document.querySelector('[laser-controls="hand: left"]');
      const rightController = document.querySelector('[laser-controls="hand: right"]');
      
      if (leftController) {
        leftController.addEventListener('thumbstickmoved', (e) => {
          const yAxis = e.detail.y;
          if (Math.abs(yAxis) > 0.1) {
            const currentScale = model.getAttribute('scale');
            const scaleFactor = yAxis > 0 ? 1.02 : 0.98;
            let newScale = currentScale.x * scaleFactor;
            newScale = Math.max(0.1, Math.min(2.0, newScale));
            model.setAttribute('scale', `${newScale} ${newScale} ${newScale}`);
          }
        });
      }
      
      if (rightController) {
        rightController.addEventListener('thumbstickmoved', (e) => {
          const yAxis = e.detail.y;
          if (Math.abs(yAxis) > 0.1) {
            const currentScale = model.getAttribute('scale');
            const scaleFactor = yAxis > 0 ? 1.02 : 0.98;
            let newScale = currentScale.x * scaleFactor;
            newScale = Math.max(0.1, Math.min(2.0, newScale));
            model.setAttribute('scale', `${newScale} ${newScale} ${newScale}`);
          }
        });
      }
    });
  </script>
</body>
</html>